pipeline {
    agent any
    tools {
        nodejs 'NodeJS'  // Use the name you configured
    }
    // Define variables used in the pipeline
    environment {
        APP_NAME = "zcrum"
        DOCKER_REGISTRY = "harivp1234" // e.g., Docker Hub username or your container registry
        DOCKER_IMAGE = "${DOCKER_REGISTRY}/${APP_NAME}"
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        // Reference credentials stored in Jenkins
        DATABASE_URL = credentials('DATABASE_URL_CREDENTIAL')
        CLERK_SECRET_KEY = credentials('CLERK_SECRET_KEY')
        NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY = credentials('NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY')
        // Docker credentials
        DOCKER_CREDENTIALS = credentials('DOCKER_CREDENTIALS')
    }
    
    // Define parameters that can be set when triggering the pipeline
    parameters {
        choice(name: 'ENVIRONMENT', choices: ['dev', 'staging', 'production'], description: 'Deployment Environment')
        booleanParam(name: 'RUN_TESTS', defaultValue: true, description: 'Run Tests?')
        booleanParam(name: 'DEPLOY', defaultValue: true, description: 'Deploy Application?')
    }
    
    stages {
        stage('Checkout') {
            steps {
                // This will automatically check out the code from your SCM
                checkout scm
                
                // Print some info about the commit
                sh "echo 'Building commit: ${env.GIT_COMMIT}'"
            }
        }
        
        stage('Install Dependencies') {
            steps {
                tool 'NodeJS'
                withEnv(["PATH+NODE=${tool 'NodeJS'}/bin"]) {
                    dir('jira-clone') {  // Add directory change to be consistent
                        sh 'npm i'
                    }
                }
            }
        }
      
        stage('Database Migration') {
            steps {
                dir('jira-clone') {
                    // Create a .env file with DATABASE_URL
                    sh '''
                    echo "DATABASE_URL=$DATABASE_URL" > .env
                    '''
                    
                    // Run Prisma migration with --force flag to handle non-empty database
                    sh 'npx prisma migrate deploy --force'
                }
            }
        }
        
        stage('Build') {
            steps {
                dir('jira-clone') {
                    // Update .env file with all environment variables
                    sh '''
                    echo "CLERK_SECRET_KEY=$CLERK_SECRET_KEY" >> .env
                    echo "NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=$NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY" >> .env
                    echo "NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in" >> .env
                    echo "NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up" >> .env
                    echo "NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/onboarding" >> .env
                    echo "NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/onboarding" >> .env
                    '''
                    
                    // Check if Docker is installed before building image
                    sh '''
                    if command -v docker &> /dev/null; then
                        docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} -t ${DOCKER_IMAGE}:latest .
                    else
                        echo "Docker not installed, skipping Docker build"
                        exit 1
                    fi
                    '''
                }
            }
        }
        
        stage('Test') {
            when {
                expression { params.RUN_TESTS == true }
            }
            steps {
                dir('jira-clone') {
                    // You can add tests here if you have them
                    sh 'echo "Running tests..."'
                    // Example: sh 'npm test'
                }
            }
        }
        
        stage('Push Docker Image') {
            steps {
                // Check if Docker is installed before pushing
                sh '''
                if command -v docker &> /dev/null; then
                    echo $DOCKER_CREDENTIALS_PSW | docker login $DOCKER_REGISTRY -u $DOCKER_CREDENTIALS_USR --password-stdin
                    docker push ${DOCKER_IMAGE}:${DOCKER_TAG}
                    docker push ${DOCKER_IMAGE}:latest
                else
                    echo "Docker not installed, skipping Docker push"
                    exit 1
                fi
                '''
            }
        }
        
        stage('Deploy') {
            when {
                expression { params.DEPLOY == true }
            }
            steps {
                // Deploy based on the selected environment
                script {
                    def deployEnv = params.ENVIRONMENT
                    
                    echo "Deploying to ${deployEnv} environment..."
                    
                    // Pass environment variables to the deploy script
                    withEnv([
                        "APP_NAME=${APP_NAME}",
                        "DOCKER_IMAGE=${DOCKER_IMAGE}",
                        "DOCKER_TAG=${DOCKER_TAG}",
                        "DEPLOY_ENV=${deployEnv}"
                    ]) {
                        switch(deployEnv) {
                            case 'dev':
                                // Development deployment
                                sh '''
                                if [ -f ./deploy.sh ]; then
                                    ./deploy.sh dev
                                else
                                    echo "deploy.sh not found, skipping deployment"
                                fi
                                '''
                                break
                            case 'staging':
                                // Staging deployment
                                sh '''
                                if [ -f ./deploy.sh ]; then
                                    ./deploy.sh staging
                                else
                                    echo "deploy.sh not found, skipping deployment"
                                fi
                                '''
                                break
                            case 'production':
                                // Add approval step for production
                                timeout(time: 1, unit: 'DAYS') {
                                    input message: 'Approve Production Deployment?', submitter: 'admin'
                                }
                                // Production deployment
                                sh '''
                                if [ -f ./deploy.sh ]; then
                                    ./deploy.sh production
                                else
                                    echo "deploy.sh not found, skipping deployment"
                                fi
                                '''
                                break
                            default:
                                echo "No environment specified"
                                break
                        }
                    }
                }
            }
        }
    }
    
    post {
        always {
            // Run on any available agent
            node(null) {
                echo "Cleaning up..."
                // Check if Docker exists before running Docker commands
                sh '''
                if command -v docker &> /dev/null; then
                    docker rmi ${DOCKER_IMAGE}:${DOCKER_TAG} || true
                    docker rmi ${DOCKER_IMAGE}:latest || true
                else
                    echo "Docker not installed, skipping cleanup"
                fi
                '''
            }
        }
        success {
            // Run on any available agent
            node(null) {
                echo "Build succeeded! Sending notifications..."
                // Send success notifications
                // slackSend channel: '#builds', color: 'good', message: "Build Succeeded: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
            }
        }
        failure {
            // Run on any available agent
            node(null) {
                echo "Build failed! Sending notifications..."
                // Send failure notifications
                // slackSend channel: '#builds', color: 'danger', message: "Build Failed: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
            }
        }
    }
}